<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>플레이스 순위 분석 - 세미콜론</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="service.css">
    <meta name="referrer" content="origin">
</head>
<body>
    <header>
        <nav class="nav-container">
            <div class="logo">
                <a href="index.html">
                    <img src="logo.png" alt="세미콜론 로고">
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">홈으로</a></li>
            </ul>
        </nav>
    </header>

    <main class="service-main">
        <div class="search-container">
            <h1>플레이스 순위 분석</h1>
            <div class="search-box">
                <input type="text" id="placeSearch" placeholder="업체명을 입력해주세요">
                <button type="button" id="searchButton">검색</button>
            </div>
            
            <div class="search-results" id="searchResults">
                <!-- 검색 결과가 여기에 표시됩니다 -->
            </div>
        </div>
    </main>

    <script>
        let selectedPlace = null;

        document.getElementById('searchButton').addEventListener('click', searchPlace);
        document.getElementById('placeSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchPlace();
            }
        });

        function searchPlace() {
            const searchTerm = document.getElementById('placeSearch').value;
            if (!searchTerm) {
                alert('검색어를 입력해주세요');
                return;
            }

            console.log('검색 시작:', searchTerm);

            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div class="loading">검색중...</div>';
            console.log(encodeURIComponent(searchTerm));
            fetch(`https://openapi.naver.com/v1/search/local.json?query=${encodeURIComponent(searchTerm)}&display=5`, {
                headers: {
                    'X-Naver-Client-Id': 'ZFHJcVxeyIYiJOET0gZt',
                    'X-Naver-Client-Secret': 't32d7AFlaU'
                }
            })
            .then(response => {
                console.log('응답 받음:', response);
                return response.json();
            })
            .then(data => {
                console.log('받은 데이터:', data);
                if (!data.items || data.items.length === 0) {
                    searchResults.innerHTML = '<div class="no-results">검색 결과가 없습니다.</div>';
                    return;
                }
                const results = data.items.map((item, index) => ({
                    id: index,
                    name: item.title.replace(/<[^>]*>/g, ''),
                    address: item.address,
                    category: item.category || '카테고리 정보 없음'
                }));
                displayResults(results);
            })
            .catch(error => {
                console.error('검색 오류:', error);
                searchResults.innerHTML = '<div class="error">검색 중 오류가 발생했습니다.</div>';
            });
        }

        function displayResults(results) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            results.forEach(place => {
                const placeElement = document.createElement('div');
                placeElement.className = 'place-item';
                placeElement.innerHTML = `
                    <h3>${place.name}</h3>
                    <p>${place.address}</p>
                    <p class="category">${place.category}</p>
                `;

                placeElement.addEventListener('click', () => selectPlace(place));
                resultsContainer.appendChild(placeElement);
            });
        }

        function selectPlace(place) {
            selectedPlace = place;
            const searchResults = document.getElementById('searchResults');
            
            const selectedPlaceElement = document.createElement('div');
            selectedPlaceElement.className = 'selected-place';
            selectedPlaceElement.innerHTML = `
                <h3>${place.name}</h3>
                <p>${place.address}</p>
                <p class="category">${place.category}</p>
                <div class="keyword-search">
                    <input type="text" id="keywordInput" placeholder="분석할 키워드를 입력해주세요">
                    <button type="button" id="analyzeButton">분석하기</button>
                </div>
            `;
            
            searchResults.innerHTML = '';
            searchResults.appendChild(selectedPlaceElement);
            
            document.getElementById('analyzeButton').addEventListener('click', () => {
                analyzeKeyword();
            });
        }

        function displayAnalysis(result) {
            const analysisElement = document.createElement('div');
            analysisElement.className = 'analysis-result';
            
            let rankDisplay;
            if (result.currentRank === 0) {
                rankDisplay = '검색 결과 없음';
            } else if (result.currentRank === 101) {
                rankDisplay = '100위권 밖';
            } else {
                rankDisplay = `${result.currentRank}위`;
            }

            analysisElement.innerHTML = `
                <h3>분석 결과</h3>
                <div class="result-item">
                    <p>현재 순위: <strong>${rankDisplay}</strong></p>
                    <p>검색량: <strong>${result.searchVolume}</strong></p>
                    <p>경쟁 강도: <strong>${result.competition}</strong></p>
                </div>
            `;

            const searchResults = document.getElementById('searchResults');
            const existingAnalysis = searchResults.querySelector('.analysis-result');
            if (existingAnalysis) {
                searchResults.removeChild(existingAnalysis);
            }
            searchResults.appendChild(analysisElement);
        }

        function calculatePlaceRank(items) {
            if (!items || items.length === 0) return 0;

            const cleanText = (text) => {
                return text.toLowerCase()
                          .replace(/<[^>]*>/g, '')
                          .replace(/&[^;]+;/g, '')
                          .replace(/\s+/g, ' ')
                          .trim();
            };

            const targetName = cleanText(selectedPlace.name);
            
            console.log('=== 순위 계산 시작 ===');
            console.log('찾으려는 업체명:', targetName);
            console.log('전체 검색 결과 수:', items.length);

            // 모든 검색 결과 출력
            items.forEach((item, index) => {
                const itemName = cleanText(item.title);
                console.log(`${index + 1}위:`, itemName);
            });

            // 순위 찾기
            for (let i = 0; i < items.length; i++) {
                const itemName = cleanText(items[i].title);
                
                if (itemName.includes(targetName) || targetName.includes(itemName)) {
                    console.log('=== 일치하는 결과 찾음 ===');
                    console.log('순위:', i + 1);
                    console.log('검색된 업체명:', itemName);
                    return i + 1;
                }
            }

            console.log('=== 일치하는 결과를 찾지 못함 ===');
            return 101;
        }

        async function searchAllPages(keyword) {
            try {
                const searchKeyword = keyword;
                console.log('검색어:', searchKeyword);
                
                const results = [];
                let start = 1;
                const display = 5;  // 고정값
                const maxResults = 500;  // 최대 500개까지 검색
                let total = 0;

                // 첫 번째 검색으로 전체 결과 수 확인
                const firstResponse = await fetch(
                    `https://openapi.naver.com/v1/search/local.json?query=${encodeURIComponent(searchKeyword)}&display=${display}&start=${start}`,
                    {
                        headers: {
                            'X-Naver-Client-Id': 'ZFHJcVxeyIYiJOET0gZt',
                            'X-Naver-Client-Secret': 't32d7AFlaU'
                        }
                    }
                );
                
                const firstData = await firstResponse.json();
                total = firstData.total;
                console.log('전체 검색 결과 수:', total);

                if (firstData.items && firstData.items.length > 0) {
                    results.push(...firstData.items);
                }

                // 나머지 결과 가져오기
                while (results.length < Math.min(total, maxResults)) {
                    start += display;
                    console.log(`검색 시작 - start: ${start}, 현재까지 결과: ${results.length}개`);
                    
                    const response = await fetch(
                        `https://openapi.naver.com/v1/search/local.json?query=${encodeURIComponent(searchKeyword)}&display=${display}&start=${start}`,
                        {
                            headers: {
                                'X-Naver-Client-Id': 'ZFHJcVxeyIYiJOET0gZt',
                                'X-Naver-Client-Secret': 't32d7AFlaU'
                            }
                        }
                    );
                    
                    const data = await response.json();
                    console.log('API 응답:', data);
                    
                    if (!data.items || data.items.length === 0) {
                        console.log('더 이상 결과가 없습니다');
                        break;
                    }
                    
                    results.push(...data.items);
                    console.log(`${start}번째부터 ${data.items.length}개 결과 추가됨`);
                    
                    if (start >= total) {
                        console.log('모든 결과를 가져왔습니다');
                        break;
                    }
                    
                    // API 호출 간 짧은 딜레이 추가
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('최종 검색 결과:', results.length, '개');
                return results;
                
            } catch (error) {
                console.error('검색 중 오류 발생:', error);
                throw error;
            }
        }

        async function analyzeKeyword() {
            const keyword = document.getElementById('keywordInput').value;
            if (!keyword || !selectedPlace) {
                alert('키워드를 입력해주세요');
                return;
            }

            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '<div class="loading">검색중...</div>';

            console.log('분석 시작:', {
                업체명: selectedPlace.name,
                검색어: keyword
            });

            try {
                // 지역 검색 결과 가져오기
                const allResults = await searchAllPages(keyword);
                console.log('최종 검색 결과:', allResults.length, '개');

                // 데이터랩 API 호출
                const datalabResponse = await fetch('https://openapi.naver.com/v1/datalab/search', {
                    method: 'POST',
                    headers: {
                        'X-Naver-Client-Id': 'ZFHJcVxeyIYiJOET0gZt',
                        'X-Naver-Client-Secret': 't32d7AFlaU',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        startDate: getDateBeforeMonth(1),
                        endDate: getToday(),
                        timeUnit: 'month',
                        keywordGroups: [{
                            groupName: keyword,
                            keywords: [keyword]
                        }]
                    })
                });
                
                const datalabData = await datalabResponse.json();
                
                const analysisResult = {
                    currentRank: calculatePlaceRank(allResults),
                    searchVolume: datalabData.results[0].data[0].ratio,
                    competition: determineCompetition(datalabData.results[0].data[0].ratio)
                };
                
                displayAnalysis(analysisResult);
            } catch (error) {
                console.error('분석 오류:', error);
                searchResults.innerHTML = '<div class="error">분석 중 오류가 발생했습니다.</div>';
            }
        }

        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function getDateBeforeMonth(months) {
            const date = new Date();
            date.setMonth(date.getMonth() - months);
            return date.toISOString().split('T')[0];
        }

        function determineCompetition(searchVolume) {
            if (searchVolume > 0.7) return "높음";
            if (searchVolume > 0.3) return "중간";
            return "낮음";
        }
    </script>
</body>
</html> 

